---
import { getCollection } from 'astro:content';
import DashboardLayout from '../layouts/DashboardLayout.astro';

// Obtener TODOS los datos de pacientes
const todosPacientes = await getCollection('datosPrincipales');

// Preparar datos para las gr√°ficas

// 1. Distribuci√≥n por sexo
const pacientesHombres = todosPacientes.filter(p => p.data.sexo === 1).length;
const pacientesMujeres = todosPacientes.filter(p => p.data.sexo === 2).length;

// 2. Distribuci√≥n por servicio
const servicios = todosPacientes.reduce((acc, p) => {
  const servicio = p.data.servicio;
  acc[servicio] = (acc[servicio] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// 3. Distribuci√≥n por edad (grupos)
const gruposEdad = todosPacientes.reduce((acc, p) => {
  const edad = p.data.edad;
  let grupo = '';
  if (edad < 18) grupo = '0-17';
  else if (edad < 30) grupo = '18-29';
  else if (edad < 45) grupo = '30-44';
  else if (edad < 60) grupo = '45-59';
  else if (edad < 75) grupo = '60-74';
  else grupo = '75+';
  acc[grupo] = (acc[grupo] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// 4. D√≠as de estancia (distribuci√≥n)
const estanciaDistribucion = todosPacientes.reduce((acc, p) => {
  const dias = p.data.estancia_dias;
  let rango = '';
  if (dias <= 3) rango = '1-3 d√≠as';
  else if (dias <= 7) rango = '4-7 d√≠as';
  else if (dias <= 14) rango = '8-14 d√≠as';
  else if (dias <= 30) rango = '15-30 d√≠as';
  else rango = 'M√°s de 30 d√≠as';
  acc[rango] = (acc[rango] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// 5. Top 10 diagn√≥sticos principales
const diagnosticos = todosPacientes.reduce((acc, p) => {
  const diag = p.data.diagnostico_principal;
  acc[diag] = (acc[diag] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const top10Diagnosticos = Object.entries(diagnosticos)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);

// 6. Distribuci√≥n por categor√≠a de ingreso
const categorias = todosPacientes.reduce((acc, p) => {
  const categoria = p.data.categoria_ingreso_descripcion || 'Sin categor√≠a';
  acc[categoria] = (acc[categoria] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// 7. Distribuci√≥n por comunidad aut√≥noma (top 7)
const comunidades = todosPacientes.reduce((acc, p) => {
  const ccaa = p.data.ccaa;
  const nombreCCAA = ccaa === 1 ? 'Andaluc√≠a' : ccaa === 2 ? 'Arag√≥n' : ccaa === 3 ? 'Asturias' : ccaa === 4 ? 'Baleares' : ccaa === 5 ? 'Canarias' : ccaa === 6 ? 'Cantabria' : ccaa === 7 ? 'Castilla Le√≥n' : 'Otras';
  acc[nombreCCAA] = (acc[nombreCCAA] || 0) + 1;
  return acc;
}, {} as Record<string, number>);
---

<DashboardLayout title="An√°lisis de Pacientes - Gr√°ficas Interactivas" activePage="prueba">
  <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
    
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">
        üìä Dashboard de An√°lisis de Pacientes
      </h1>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Exploraci√≥n interactiva de datos cl√≠nicos
      </p>
    </header>

    {/* Nota informativa */}
    <section class="mb-8 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
      <p class="text-sm text-blue-800 dark:text-blue-200">
        üìà <strong>An√°lisis de {todosPacientes.length.toLocaleString()} pacientes</strong> | 
        Gr√°ficas interactivas con Apache ECharts ‚Äî pasa el rat√≥n sobre las gr√°ficas para m√°s informaci√≥n.
      </p>
    </section>

    {/* Contenedor de gr√°ficas */}
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      {/* Gr√°fica 1: Sexo */}
      <article class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Distribuci√≥n por Sexo</h2>
        <div id="chartSexo" style="height: 400px;"></div>
      </article>

      {/* Gr√°fica 2: Servicio */}
      <article class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Distribuci√≥n por Servicio</h2>
        <div id="chartServicios" style="height: 400px;"></div>
      </article>

      {/* Gr√°fica 3: Edad */}
      <article class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Distribuci√≥n por Grupos de Edad</h2>
        <div id="chartEdad" style="height: 400px;"></div>
      </article>

      {/* Gr√°fica 4: Estancia */}
      <article class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Distribuci√≥n de D√≠as de Estancia</h2>
        <div id="chartEstancia" style="height: 400px;"></div>
      </article>

      {/* Gr√°fica 5: Diagn√≥sticos */}
      <article class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700 lg:col-span-2">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Top 10 Diagn√≥sticos Principales</h2>
        <div id="chartDiagnosticos" style="height: 500px;"></div>
      </article>

      {/* Gr√°fica 6: Categor√≠a de Ingreso */}
      <article class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Distribuci√≥n por Categor√≠a</h2>
        <div id="chartCategorias" style="height: 400px;"></div>
      </article>

      {/* Gr√°fica 7: Comunidad Aut√≥noma */}
      <article class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Distribuci√≥n por CCAA</h2>
        <div id="chartComunidades" style="height: 400px;"></div>
      </article>

    </section>
  </main>
</DashboardLayout>


<script>
  import * as echarts from 'echarts';

  // Detectar tema oscuro
  const isDark = document.documentElement.classList.contains('dark');
  const theme = isDark ? 'dark' : 'light';

  // Colores para tema claro y oscuro
  const colors = {
    light: {
      text: '#374151',
      background: '#ffffff',
      grid: '#e5e7eb',
    },
    dark: {
      text: '#d1d5db',
      background: '#1f2937',
      grid: '#374151',
    }
  };

  const currentColors = isDark ? colors.dark : colors.light;

  // Gr√°fica 1: Distribuci√≥n por Sexo (Pie Chart)
  const chartSexo = echarts.init(document.getElementById('chartSexo'));
  chartSexo.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c} ({d}%)'
    },
    legend: {
      orient: 'vertical',
      left: 'left',
      textStyle: { color: currentColors.text }
    },
    series: [
      {
        name: 'Distribuci√≥n por Sexo',
        type: 'pie',
        radius: '70%',
        data: [
          { value: window.sexoData.hombres, name: 'Hombres' },
          { value: window.sexoData.mujeres, name: 'Mujeres' }
        ],
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        },
        label: {
          color: currentColors.text
        }
      }
    ]
  });

  // Gr√°fica 2: Distribuci√≥n por Servicio (Bar Chart)
  const chartServicios = echarts.init(document.getElementById('chartServicios'));
  chartServicios.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: Object.keys(window.serviciosData),
      axisLabel: { color: currentColors.text }
    },
    yAxis: {
      type: 'value',
      axisLabel: { color: currentColors.text }
    },
    series: [
      {
        name: 'Pacientes',
        type: 'bar',
        data: Object.values(window.serviciosData),
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: '#83bff6' },
            { offset: 1, color: '#188df0' }
          ])
        }
      }
    ]
  });

  // Gr√°fica 3: Distribuci√≥n por Grupos de Edad (Doughnut)
  const chartEdad = echarts.init(document.getElementById('chartEdad'));
  chartEdad.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c} ({d}%)'
    },
    legend: {
      orient: 'vertical',
      right: 'right',
      textStyle: { color: currentColors.text }
    },
    series: [
      {
        name: 'Grupos de Edad',
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: currentColors.background,
          borderWidth: 2
        },
        label: {
          show: false,
          position: 'center'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 20,
            fontWeight: 'bold',
            color: currentColors.text
          }
        },
        labelLine: {
          show: false
        },
        data: Object.entries(window.edadData).map(([key, value]) => ({
          value: value,
          name: key
        }))
      }
    ]
  });

  // Gr√°fica 4: Distribuci√≥n de Estancia (Bar Chart Horizontal)
  const chartEstancia = echarts.init(document.getElementById('chartEstancia'));
  chartEstancia.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'value',
      axisLabel: { color: currentColors.text }
    },
    yAxis: {
      type: 'category',
      data: Object.keys(window.estanciaData),
      axisLabel: { color: currentColors.text }
    },
    series: [
      {
        name: 'Pacientes',
        type: 'bar',
        data: Object.values(window.estanciaData),
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
            { offset: 0, color: '#f093fb' },
            { offset: 1, color: '#f5576c' }
          ])
        }
      }
    ]
  });

  // Gr√°fica 5: Top 10 Diagn√≥sticos (Bar Chart)
  const chartDiagnosticos = echarts.init(document.getElementById('chartDiagnosticos'));
  chartDiagnosticos.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'value',
      axisLabel: { color: currentColors.text }
    },
    yAxis: {
      type: 'category',
      data: window.diagnosticosData.map((d: any) => d[0]),
      axisLabel: { 
        color: currentColors.text,
        fontSize: 11
      }
    },
    series: [
      {
        name: 'Casos',
        type: 'bar',
        data: window.diagnosticosData.map((d: any) => d[1]),
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
            { offset: 0, color: '#4facfe' },
            { offset: 1, color: '#00f2fe' }
          ])
        }
      }
    ]
  });

  // Gr√°fica 6: Distribuci√≥n por Categor√≠a (Radar Chart con puntos individuales)
  const chartCategorias = echarts.init(document.getElementById('chartCategorias'));
  const categoriaEntries = Object.entries(window.categoriasData);
  const maxValorCategoria = Math.max(...Object.values(window.categoriasData));
  
  // Crear m√∫ltiples series, una por cada categor√≠a
  const radarSeries = categoriaEntries.map(([categoria, valor], index) => {
    const values = new Array(categoriaEntries.length).fill(0);
    values[index] = valor;
    return {
      name: categoria,
      type: 'radar',
      symbol: 'circle',
      symbolSize: 8,
      lineStyle: {
        width: 1.5,
        opacity: 0.8
      },
      areaStyle: {
        opacity: 0.1
      },
      data: [
        {
          value: values,
          name: categoria,
          itemStyle: {
            color: `hsl(${(index * 360) / categoriaEntries.length}, 70%, 60%)`
          }
        }
      ]
    };
  });
  
  chartCategorias.setOption({
    tooltip: {
      trigger: 'item',
      confine: true,
      appendToBody: true,
      className: 'custom-tooltip',
      formatter: function(params: any) {
        return `<strong>${params.seriesName}</strong><br/>Pacientes: ${params.value.find((v: number) => v > 0) || 0}`;
      },
      extraCssText: 'z-index: 10000;'
    },
    legend: {
      show: false
    },
    radar: {
      indicator: categoriaEntries.map(([key]) => ({
        name: key.length > 15 ? key.substring(0, 15) + '...' : key,
        max: maxValorCategoria
      })),
      axisName: {
        color: currentColors.text,
        fontSize: 11
      }
    },
    series: radarSeries
  });

  // Gr√°fica 7: Distribuci√≥n por Comunidad Aut√≥noma (Pie Chart)
  const chartComunidades = echarts.init(document.getElementById('chartComunidades'));
  chartComunidades.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c} ({d}%)'
    },
    legend: {
      orient: 'vertical',
      left: 'left',
      textStyle: { color: currentColors.text }
    },
    series: [
      {
        name: 'Comunidades Aut√≥nomas',
        type: 'pie',
        radius: '70%',
        data: Object.entries(window.comunidadesData).map(([key, value]) => ({
          value: value,
          name: key
        })),
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        },
        label: {
          color: currentColors.text
        }
      }
    ]
  });

  // Hacer las gr√°ficas responsive
  window.addEventListener('resize', () => {
    chartSexo.resize();
    chartServicios.resize();
    chartEdad.resize();
    chartEstancia.resize();
    chartDiagnosticos.resize();
    chartCategorias.resize();
    chartComunidades.resize();
  });
</script>

<script is:inline define:vars={{ 
  sexoData: { hombres: pacientesHombres, mujeres: pacientesMujeres },
  serviciosData: servicios,
  edadData: gruposEdad,
  estanciaData: estanciaDistribucion,
  diagnosticosData: top10Diagnosticos,
  categoriasData: categorias,
  comunidadesData: comunidades
}}>
  window.sexoData = sexoData;
  window.serviciosData = serviciosData;
  window.edadData = edadData;
  window.estanciaData = estanciaData;
  window.diagnosticosData = diagnosticosData;
  window.categoriasData = categoriasData;
  window.comunidadesData = comunidadesData;
</script>
